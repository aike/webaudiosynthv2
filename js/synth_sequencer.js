/*
 * synth_sequencer.js
 *
 * This program is licensed under the MIT License.
 * Copyright 2015, aike (@aike1000)
 *
 */

var Sequencer = function() {
	var base = 180

	var f1   = Math.floor(base * 10);
	var f8   = Math.floor(base * 5);
	var n4   = Math.floor(base * 4);
	var n8a  = Math.floor(base * 2.5);
	var n8   = Math.floor(base * 2);
	var n16a = Math.floor(base * 2);
	var n16b = Math.floor(base * 1.25);
	var n16  = Math.floor(base * 1);
	var n32  = Math.floor(base / 4);
	var r32  = Math.floor(base * 5 / 4);

	var nt = -1;

	// J.S.Bach - Suite No 1 in G major BWV 1007 Prelude
	this.note = [
		43, 50, 59, 57, 59, 50, 59, 50,  43, 50, 59, 57, 59, 50, 59, 50, // 1
		43, 52, 60, 59, 60, 52, 60, 52,  43, 52, 60, 59, 60, 52, 60, 52,
		43, 54, 60, 59, 60, 54, 60, 54,  43, 54, 60, 59, 60, 54, 60, 54, // 3
		43, 55, 59, 57, 59, 55, 59, 55,  43, 55, 59, 57, 59, 55, 59, 55,
		43, 52, 59, 57, 59, 55, 54, 55,  52, 55, 54, 55, 47, 50, 49, 47, // 5
		49, 55, 57, 55, 57, 55, 57, 55,  49, 55, 57, 55, 57, 55, 57, 55,
		54, 57, 62, 61, 62, 57, 55, 57,  54, 57, 55, 57, 50, 54, 52, 50, // 7
		40, 47, 55, 54, 55, 47, 55, 47,  40, 47, 55, 54, 55, 47, 55, 47, 
		40, 49, 50, 52, 50, 49, 47, 45,  55, 54, 52, 62, 61, 59, 57, 55, // 9
		54, 52, 50, 62, 57, 62, 54, 57,  50, 52, 54, 57, 55, 54, 52, 50,
		56, 50, 53, 52, 53, 50, 55, 50,  59, 50, 53, 52, 53, 50, 55, 50, // 11
		48, 52, 57, 59, 60, 57, 52, 50,  48, 52, 57, 59, 60, 57, 54, 52,
		51, 54, 51, 54, 57, 54, 57, 54,  51, 54, 51, 54, 57, 54, 57, 54, // 13
		55, 54, 52, 55, 54, 55, 57, 54,  55, 54, 52, 50, 48, 47, 45, 43,
		42, 48, 50, 48, 50, 48, 50, 48,  42, 48, 50, 48, 50, 48, 50, 48, // 15
		43, 47, 53, 52, 53, 47, 53, 47,  43, 47, 53, 52, 53, 47, 53, 47,
		43, 48, 52, 50, 52, 48, 52, 48,  43, 48, 52, 50, 52, 48, 52, 48, // 17
		43, 54, 60, 59, 60, 54, 60, 54,  43, 54, 60, 59, 60, 54, 60, 54,
		43, 47, 59, 57, 59, 55, 54, 52,  50, 48, 47, 45, 43, 42, 40, 38, // 19
		37, 45, 52, 54, 55, 52, 54, 55,  37, 45, 52, 54, 55, 52, 54, 55,
		36, 45, 50, 52, 54, 50, 52, 54,  38, 45, 50, 52, 54, 50, 52, 54, // 21
		36, 45, 50, 54, 57, 61, 60, 62,      45, 47, 48, 50, 52, 54, 55,
		57, 54, 50, 52, 54, 55, 57, 59,  60, 57, 54, 55, 57, 59, 60, 62, // 23
		63, 62, 61, 62, 62, 60, 59, 60,  60, 57, 54, 52, 50, 45, 47, 48,
		38, 45, 50, 54, 57, 59, 60, 57,  59, 55, 50, 48, 47, 43, 45, 47, // 25
		38, 43, 47, 50, 55, 57, 59, 55,  61, 59, 57, 58, 58, 57, 56, 57,
		57, 55, 54, 55, 55, 52, 49, 47,  45, 49, 52, 55, 57, 61, 62, 61, // 27
		62, 57, 54, 52, 54, 57, 50, 54,  45, 50, 49, 47, 45, 43, 42, 40,
		38,     60, 59, 57, 55, 54, 52,  50, 60, 59, 57, 55, 54, 52, 50, // 29
		48, 59, 57, 55, 54, 52, 50, 48,  47, 57, 55, 54, 52, 50, 48, 47,
		45, 55, 54, 52, 54, 57, 50, 57,  52, 57, 54, 57, 55, 57, 52, 57, // 31
		54, 57, 50, 57, 55, 57, 52, 57,  54, 57, 50, 57, 55, 57, 52, 57,
		54, 57, 50, 57, 52, 57, 54, 57,  55, 57, 57, 57, 59, 57, 50, 57, // 33
		57, 57, 59, 57, 60, 57, 50, 57,  59, 57, 60, 57, 62, 57, 59, 57,
		60, 57, 59, 57, 60, 57, 57, 57,  59, 57, 57, 57, 59, 57, 55, 57, // 35
		57, 57, 55, 57, 57, 57, 54, 57,  55, 57, 54, 57, 55, 57, 52, 57,
		54, 57, 50, 52, 53, 50, 54, 50,  55, 50, 56, 50, 57, 50, 58, 50, // 37
		59, 50, 60, 50, 61, 50, 62, 50,  63, 50, 64, 50, 65, 50, 66, 50,
		67, 59, 50, 59, 67, 59, 67, 59,  67, 59, 50, 59, 67, 59, 67, 59, // 39
		67, 57, 50, 57, 67, 57, 67, 57,  67, 57, 50, 57, 67, 57, 67, 57,
		66, 60, 50, 60, 66, 60, 66, 60,  66, 60, 50, 60, 66, 60, 66, 60, // 41
		55
	];
	this.steptime = [
		n16a,n16, n16, n16, n16, n16, n16, n16,  n16b,n16, n16, n16, n16, n16, n16, n16, // 1
		n16a,n16, n16, n16, n16, n16, n16, n16,  n16b,n16, n16, n16, n16, n16, n16, n16,
		n16b,n16, n16, n16, n16, n16, n16, n16,  n16b,n16, n16, n16, n16, n16, n16, n16, // 3
		n16b,n16, n16, n16, n16, n16, n16, n16,  n16b,n16, n16, n16, n16, n16, n16, n16,
		n16a,n16, n16, n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16, n16, n16, n16, // 5
		n16a,n16, n16, n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16, n16, n16, n16,
		n16, n16, n16, n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16, n16, n16, n16, // 7
		n16, n16, n16, n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16, n16, n16, n16,
		n16, n16, n16, n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16, n16, n16, n16, // 9
		n16, n16, n16, n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16, n16, n16, n16,
		n16a,n16, n16, n16, n16, n16, n16, n16,  n16b,n16, n16, n16, n16, n16, n16, n16, // 11
		n16b,n16, n16, n16, n16, n16, n16, n16,  n16b,n16, n16, n16, n16, n16, n16, n16,
		n16a,n16, n16, n16, n16, n16, n16, n16,  n16b,n16, n16, n16, n16, n16, n16, n16, // 13
		n16b,n16, n16, n16, n16, n16, n16, n16,  n16b,n16, n16, n16, n16, n16, n16, n16,
		n16a,n16, n16, n16, n16, n16, n16, n16,  n16b,n16, n16, n16, n16, n16, n16, n16, // 15
		n16a,n16, n16, n16, n16, n16, n16, n16,  n16b,n16, n16, n16, n16, n16, n16, n16,
		n16a,n16, n16, n16, n16, n16, n16, n16,  n16b,n16, n16, n16, n16, n16, n16, n16, // 17
		n16a,n16, n16, n16, n16, n16, n16, n16,  n16b,n16, n16, n16, n16, n16, n16, n16,
		n16a,n16b,n16b,n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16, n16, n16, n16, // 19
		n16a,n16, n16, n16, n16, n16, n16, n16,  n16a,n16, n16, n16, n16, n16, n16, n16,
		n16a,n16, n16, n16, n16, n16, n16, n16,  n16b,n16, n16, n16, n16, n16, n16, n16, // 21
		n16a,n16, n16, n16, n16, n16, n16, f8,        n16, n16, n16, n16, n16, n16, n16,
		n16, n16, n16, n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16, n16, n16, n16, // 23
		n16, n16, n16, n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16, n16, n16, n16,
		n16, n16, n16, n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16, n16, n16, n16, // 25
		n16, n16, n16, n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16, n16, n16, n16,
		n16, n16, n16, n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16, n16, n16, n16, // 27
		n16, n16, n16, n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16, n16, n16, n16,
		n8,       n16, n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16, n16, n16, n16, // 29
		n16, n16, n16, n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16, n16, n16, n16,
		n16a, n16, n16, n16, n16, n16, n16, n16,  n16b, n16, n16, n16, n16, n16, n16, n16, // 31
		n16a, n16, n16, n16, n16, n16, n16, n16,  n16b, n16, n16, n16, n16, n16, n16, n16,
		n16a, n16, n16, n16, n16, n16, n16, n16,  n16b, n16, n16, n16, n16, n16, n16, n16, // 33
		n16a, n16, n16, n16, n16, n16, n16, n16,  n16b, n16, n16, n16, n16, n16, n16, n16,
		n16a, n16, n16, n16, n16, n16, n16, n16,  n16b, n16, n16, n16, n16, n16, n16, n16, // 35
		n16a, n16, n16, n16, n16, n16, n16, n16,  n16b, n16, n16, n16, n16, n16, n16, n16,
		n16a, n16, n16, n16, n16, n16, n16, n16,  n16b, n16, n16, n16, n16, n16, n16, n16, // 37
		n16a, n16, n16, n16, n16, n16, n16, n16,  n16b, n16, n16, n16, n16, n16, n16, n16,
		n16a,n16, n16, n16, n16b,n16, n16, n16,  n16b,n16, n16, n16, n16b,n16, n16, n16, // 39
		n16a,n16, n16, n16, n16b,n16, n16, n16,  n16b,n16, n16, n16, n16b,n16, n16, n16,
		n16, n16, n16, n16, n16, n16, n16, n16,  n16, n16, n16, n16, n16b,n16b,n16b,n8a, // 41
		f1
	];
	// TODO: 
	// Math.floor(duration * duration2 / 100) にする
	this.gatetime = [
		 50,  50,  50,  50,  50,  50,  50,  50,   60,  60,  60,  60,  60,  60,  60,  60, // 1
		 65,  65,  65,  65,  65,  65,  65,  65,   65,  65,  65,  65,  65,  65,  65,  65,
		 70,  70,  70,  70,  70,  70,  70,  70,   50,  50,  50,  50,  50,  50,  50,  50, // 3
		 50,  50,  50,  50,  50,  50,  50,  50,   50,  50,  50,  50,  50,  50,  50,  50,
		 50,  50,  50,  50,  50,  50,  50,  50,   60,  60,  60,  60,  60,  60,  60,  60, // 5
		 65,  65,  65,  65,  65,  65,  65,  65,   65,  65,  65,  65,  65,  65,  65,  65,
		 70,  70,  70,  70,  70,  70,  70,  70,   50,  50,  50,  50,  50,  50,  50,  50, // 7
		 50,  50,  50,  50,  50,  50,  50,  50,   50,  50,  50,  50,  50,  50,  50,  50,
		 50,  50,  50,  50,  50,  50,  50,  50,   60,  60,  60,  60,  60,  60,  60,  60, // 9
		 65,  65,  65,  65,  65,  65,  65,  65,   65,  65,  65,  65,  65,  65,  65,  65,
		 70,  70,  70,  70,  70,  70,  70,  70,   50,  50,  50,  50,  50,  50,  50,  50, // 11
		 50,  50,  50,  50,  50,  50,  50,  50,   50,  50,  50,  50,  50,  50,  50,  50,
		 50,  50,  50,  50,  50,  50,  50,  50,   60,  60,  60,  60,  60,  60,  60,  60, // 13
		 65,  65,  65,  65,  65,  65,  65,  65,   65,  65,  65,  65,  65,  65,  65,  65,
		 70,  70,  70,  70,  70,  70,  70,  70,   50,  50,  50,  50,  50,  50,  50,  50, // 15
		 50,  50,  50,  50,  50,  50,  50,  50,   50,  50,  50,  50,  50,  50,  50,  50,
		 50,  50,  50,  50,  50,  50,  50,  50,   60,  60,  60,  60,  60,  60,  60,  60, // 17
		 65,  65,  65,  65,  65,  65,  65,  65,   65,  65,  65,  65,  65,  65,  65,  65,
		 70,  70,  70,  70,  70,  70,  70,  70,   65,  65,  65,  65,  65,  65,  65,  65, // 19
		 65,  65,  65,  65,  65,  65,  65,  65,   60,  60,  60,  60,  60,  60,  60,  60,
		 65,  65,  65,  65,  65,  65,  65,  65,   70,  70,  70,  70,  70,  70,  70,  70, // 21
		 70,  70,  70,  70,  70,  70,  70,  70,        40,  41,  42,  43,  44,  45,  46,
		 47,  48,  49,  50,  51,  52,  53,  54,   55,  56,  57,  58,  59,  60,  60,  60, // 23
		 60,  60,  60,  60,  60,  60,  60,  60,   60,  60,  60,  60,  60,  60,  60,  60,
		 50,  50,  50,  50,  50,  50,  50,  50,   60,  60,  60,  60,  60,  60,  60,  60, // 25
		 65,  65,  65,  65,  65,  65,  65,  65,   60,  60,  60,  60,  60,  60,  60,  60,
		 50,  50,  50,  50,  50,  50,  50,  50,   60,  60,  60,  60,  60,  60,  60,  60, // 27
		 65,  65,  65,  65,  65,  65,  65,  65,   70,  70,  70,  70,  70,  70,  70,  40,
		 40,       30,  30,  30,  30,  30,  30,   30,  30,  30,  30,  30,  30,  30,  30, // 29
		 30,  30,  40,  40,  40,  40,  40,  40,   40,  40,  50,  50,  50,  50,  50,  50,
		 50,  50,  40,  40,  40,  40,  40,  40,   40,  40,  60,  60,  60,  60,  60,  60, // 31
		 60,  60,  60,  60,  60,  60,  60,  60,   65,  65,  65,  65,  65,  65,  65,  65,
		 50,  50,  50,  50,  50,  50,  50,  50,   60,  60,  60,  60,  60,  60,  60,  60, // 33
		 65,  65,  65,  65,  65,  65,  65,  65,   65,  65,  65,  65,  65,  65,  65,  65,
		 70,  70,  70,  70,  70,  70,  70,  70,   50,  50,  50,  50,  50,  50,  50,  50, // 35
		 50,  50,  50,  50,  50,  50,  50,  50,   50,  50,  50,  50,  50,  50,  50,  50,
		 40,  40,  41,  42,  43,  44,  45,  46,   47,  48,  49,  50,  51,  52,  53,  54, // 37
		 55,  56,  57,  58,  59,  60,  61,  62,   63,  64,  65,  66,  67,  68,  69,  70,
		 70,  50,  50,  50,  60,  60,  60,  60,   70,  50,  50,  50,  60,  60,  60,  60, // 39
		 70,  55,  55,  55,  66,  60,  60,  60,   70,  60,  60,  60,  60,  60,  60,  60,
		 60,  60,  60,  60,  60,  60,  60,  60,   70,  70,  70,  70,  70,  70,  70,  70, // 41
		 60,  60,  60,  60,  60,  60,  60,  60,   70,  70,  70,  70,  70,  70,  70,  70, 
		 100,
	];
	this.btn = gui.obj('play');
	this.playing = false;
}

Sequencer.prototype.play = function() {
	this.playing = true;
	this.playsub(0);
}

Sequencer.prototype.playsub = function(pos) {
	var self = this;
	if (pos >= this.note.length) {
		ctrl.stop_demo(true);
	} else if (this.playing) {
		if (self.note[pos] !== -1) {
			ctrl.note_on(self.note[pos]);
			setTimeout(function() {
				ctrl.note_off(self.note[pos]);},
				this.steptime[pos] * this.gatetime[pos] / 100);
		}
		setTimeout(function() {self.playsub(pos + 1);}, this.steptime[pos]);
	}
};

Sequencer.prototype.stop = function() {
	this.playing = false;
}

var sequencer;
$(function() {
	sequencer = new Sequencer();
});
